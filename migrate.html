<!DOCTYPE html>
<html lang="tr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Migrate to Supabase</title>
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        max-width: 800px;
        margin: 50px auto;
        padding: 20px;
        background: #f5f5f5;
      }
      .container {
        background: white;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }
      h1 {
        color: #2e7d32;
      }
      button {
        background: #d4af37;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 16px;
        cursor: pointer;
        margin: 10px 5px;
      }
      button:hover {
        background: #3e2723;
      }
      .info {
        background: #e3f2fd;
        padding: 15px;
        border-radius: 8px;
        margin: 20px 0;
        border-left: 4px solid #2196f3;
      }
      .warning {
        background: #fff3e0;
        padding: 15px;
        border-radius: 8px;
        margin: 20px 0;
        border-left: 4px solid #ff9800;
      }
      .success {
        background: #e8f5e9;
        padding: 15px;
        border-radius: 8px;
        margin: 20px 0;
        border-left: 4px solid #4caf50;
      }
      .error {
        background: #ffebee;
        padding: 15px;
        border-radius: 8px;
        margin: 20px 0;
        border-left: 4px solid #f44336;
      }
      pre {
        background: #263238;
        color: #aed581;
        padding: 15px;
        border-radius: 8px;
        overflow-x: auto;
      }
      .products-list {
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid #ddd;
        padding: 10px;
        border-radius: 8px;
        margin: 10px 0;
      }
      .product-item {
        padding: 8px;
        border-bottom: 1px solid #eee;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üöÄ Migrate LocalStorage to Supabase</h1>

      <div class="info">
        <strong>‚ÑπÔ∏è What does this do?</strong><br />
        This tool helps you migrate your existing products from localStorage to
        Supabase database.
      </div>

      <div class="warning">
        <strong>‚ö†Ô∏è Before you start:</strong><br />
        1. Make sure you've completed all steps in
        <strong>SUPABASE-SETUP.md</strong><br />
        2. Your Supabase database tables should be created<br />
        3. Your API keys should be configured in
        <strong>supabase-config.js</strong>
      </div>

      <h2>Current LocalStorage Data</h2>
      <div id="localStorageData"></div>

      <button onclick="viewLocalStorage()">üìã View LocalStorage Data</button>
      <button onclick="migrateToSupabase()">‚¨ÜÔ∏è Migrate to Supabase</button>
      <button onclick="clearLocalStorage()">üóëÔ∏è Clear LocalStorage</button>

      <div id="result"></div>

      <h2>üìñ Next Steps After Migration</h2>
      <ol>
        <li>Test your shop at <strong>shop.html</strong></li>
        <li>Test your admin panel at <strong>admin.html</strong></li>
        <li>Verify data in Supabase Dashboard</li>
        <li>Once confirmed, you can clear localStorage</li>
      </ol>
    </div>

    <!-- Supabase JS Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>

    <script>
      function viewLocalStorage() {
        const products = JSON.parse(localStorage.getItem("products")) || [];
        const cart = JSON.parse(localStorage.getItem("cart")) || [];

        const resultDiv = document.getElementById("localStorageData");

        if (products.length === 0) {
          resultDiv.innerHTML =
            '<div class="info">No products found in localStorage.</div>';
          return;
        }

        let html = `
                <div class="success">
                    <strong>Found ${
                      products.length
                    } products in localStorage:</strong>
                    <div class="products-list">
                        ${products
                          .map(
                            (p) => `
                            <div class="product-item">
                                <strong>${p.name}</strong> - ${p.price}‚Ç∫ (Stock: ${p.stock})
                            </div>
                        `
                          )
                          .join("")}
                    </div>
                </div>
            `;

        if (cart.length > 0) {
          html += `<div class="info">Cart has ${cart.length} items</div>`;
        }

        resultDiv.innerHTML = html;
      }

      async function migrateToSupabase() {
        const resultDiv = document.getElementById("result");
        resultDiv.innerHTML = '<div class="info">‚è≥ Migrating data...</div>';

        try {
          // Check if Supabase is configured
          if (SUPABASE_URL === "YOUR_SUPABASE_URL") {
            resultDiv.innerHTML =
              '<div class="error">‚ùå Please configure your Supabase credentials in supabase-config.js first!</div>';
            return;
          }

          const products = JSON.parse(localStorage.getItem("products")) || [];

          if (products.length === 0) {
            resultDiv.innerHTML =
              '<div class="warning">‚ö†Ô∏è No products found in localStorage to migrate.</div>';
            return;
          }

          // Get existing products from Supabase
          const { data: existingProducts } = await supabase
            .from("products")
            .select("id, name");

          const existingNames = new Set(
            existingProducts?.map((p) => p.name) || []
          );

          // Filter out products that already exist
          const newProducts = products.filter(
            (p) => !existingNames.has(p.name)
          );

          if (newProducts.length === 0) {
            resultDiv.innerHTML =
              '<div class="warning">‚ö†Ô∏è All products already exist in Supabase. No migration needed.</div>';
            return;
          }

          // Remove IDs to let Supabase auto-generate them
          const productsToInsert = newProducts.map(({ id, ...rest }) => rest);

          // Insert products
          const { data, error } = await supabase
            .from("products")
            .insert(productsToInsert)
            .select();

          if (error) throw error;

          resultDiv.innerHTML = `
                    <div class="success">
                        <strong>‚úÖ Migration successful!</strong><br>
                        Migrated ${data.length} products to Supabase.<br>
                        Skipped ${
                          products.length - newProducts.length
                        } products (already exist).<br><br>
                        <strong>What's next?</strong><br>
                        1. Test your shop and admin pages<br>
                        2. Verify data in Supabase Dashboard<br>
                        3. Clear localStorage once confirmed
                    </div>
                `;
        } catch (error) {
          console.error("Migration error:", error);
          resultDiv.innerHTML = `
                    <div class="error">
                        <strong>‚ùå Migration failed!</strong><br>
                        Error: ${error.message}<br><br>
                        <strong>Common issues:</strong><br>
                        ‚Ä¢ API keys not configured correctly<br>
                        ‚Ä¢ Database tables not created<br>
                        ‚Ä¢ RLS policies not set up<br><br>
                        Check the console for detailed error.
                    </div>
                `;
        }
      }

      function clearLocalStorage() {
        if (
          !confirm(
            "Are you sure you want to clear localStorage? This will remove all local products and cart data."
          )
        ) {
          return;
        }

        localStorage.removeItem("products");
        localStorage.removeItem("cart");

        document.getElementById("result").innerHTML =
          '<div class="success">‚úÖ LocalStorage cleared!</div>';
        document.getElementById("localStorageData").innerHTML = "";
      }

      // Auto-view on load
      viewLocalStorage();
    </script>
  </body>
</html>

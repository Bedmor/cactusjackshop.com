name: Deploy to GitHub Pages

on:
  push:
    branches:
      - master # or main, depending on your default branch
  workflow_dispatch:

permissions:
  contents: write

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Create supabase-config.js from secrets
        run: |
          cat > supabase-config.js << 'EOF'
          // Supabase Configuration
          // Auto-generated from GitHub Actions secrets

          const SUPABASE_URL = '${{ secrets.SUPABASE_URL }}';
          const SUPABASE_ANON_KEY = '${{ secrets.SUPABASE_ANON_KEY }}';

          // Initialize Supabase client
          const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

          // Database helper functions
          const db = {

              // Get all comments
              async getComments() {
                  const { data, error } = await supabase
                      .from('comments')
                      .select('*')
                      .order('created_at', { ascending: false });

                  if (error) {
                      console.error('Error fetching comments:', error);
                      return [];
                  }
                  return data || [];
              },

              // Get single comment
              async getComment(id) {
                  const { data, error } = await supabase
                      .from('comments')
                      .select('*')
                      .eq('id', id)
                      .single();

                  if (error) {
                      console.error('Error fetching comment:', error);
                      throw error;
                  }
                  return data;
              },

              // Add new comment
              async addComment(comment) {
                  const { data, error } = await supabase
                      .from('comments')
                      .insert([comment])
                      .select()
                      .single();

                  if (error) {
                      console.error('Error adding comment:', error);
                      throw error;
                  }
                  return data;
              },

              // Update comment
              async updateComment(id, updates) {
                  const { data, error } = await supabase
                      .from('comments')
                      .update(updates)
                      .eq('id', id)
                      .select()
                      .single();

                  if (error) {
                      console.error('Error updating comment:', error);
                      throw error;
                  }
                  return data;
              },

              // Delete comment
              async deleteComment(id) {
                  const { error } = await supabase
                      .from('comments')
                      .delete()
                      .eq('id', id);

                  if (error) {
                      console.error('Error deleting comment:', error);
                      throw error;
                  }
                  return true;
              },

              // Get all products
              async getProducts() {
                  const { data, error } = await supabase
                      .from('products')
                      .select('*')
                      .order('created_at', { ascending: false });

                  if (error) {
                      console.error('Error fetching products:', error);
                      return [];
                  }
                  return data || [];
              },

              // Get single product
              async getProduct(id) {
                  const { data, error } = await supabase
                      .from('products')
                      .select('*')
                      .eq('id', id)
                      .single();

                  if (error) {
                      console.error('Error fetching product:', error);
                      throw error;
                  }
                  return data;
              },

              // Add new product
              async addProduct(product) {
                  const { data, error } = await supabase
                      .from('products')
                      .insert([product])
                      .select()
                      .single();

                  if (error) {
                      console.error('Error adding product:', error);
                      throw error;
                  }
                  return data;
              },

              // Update product
              async updateProduct(id, updates) {
                  const { data, error } = await supabase
                      .from('products')
                      .update(updates)
                      .eq('id', id)
                      .select()
                      .single();

                  if (error) {
                      console.error('Error updating product:', error);
                      throw error;
                  }
                  return data;
              },

              // Delete product
              async deleteProduct(id) {
                  const { error } = await supabase
                      .from('products')
                      .delete()
                      .eq('id', id);

                  if (error) {
                      console.error('Error deleting product:', error);
                      throw error;
                  }
                  return true;
              }
          };
          EOF

      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add supabase-config.js
          git diff --staged --quiet || git commit -m "Update supabase-config.js from secrets [skip ci]"
          git push
